---
title: "Chicago DA NOTEBOOK"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

### library activation ###
```{r}
library(ggplot2)  
library(dplyr)
library(readr)
library(tidyr)
library(caTools)
library(caret)
library(ROCR)
library(xgboost)
library(ggforce)
library(data.table)
library(gdata)
library(DMwR)
theme_set(theme_bw())
```

### data input ###
```{r}

# setwd
setwd("C:/Users/xaxa067/Documents/Job/Analytics/R/CLSJ")

#-------#

## Dispositions ##
dispositions <- read_csv('./Dispositions.csv',col_types = cols(.default = "c")) %>%
  mutate(CLASS = ifelse(CLASS=='M', 5, CLASS), # Misdemeanor is encoded as 5 
         CLASS = ifelse(CLASS=='X', 0, CLASS)) %>% # X is encoded as 0
  filter(CLASS %in% c(0, 1, 2, 3, 4, 5))

# CHECK - One `PARTICIPANT_ID` per `CASE_ID`
length(unique(dispositions$CASE_PARTICIPANT_ID)) ==length(dispositions$CASE_PARTICIPANT_ID)

# remove duplicates
dispositions <- dispositions %>% distinct()

# n_occur <- data.frame(table(dispositions2$CHARGE_ID))
# n_occur <- dispositions2[dispositions2$CHARGE_ID %in% n_occur$Var1[n_occur$Freq > 1],]

#-------#

## INITIATION ##
initiations <- read_csv('./Initiation.csv',col_types = cols(.default = "c")) %>%
  mutate(CLASS = ifelse(CLASS=='M', 5, CLASS),
         CLASS = ifelse(CLASS=='X', 0, CLASS)) %>%
  filter(CLASS %in% c(0, 1, 2, 3, 4, 5))

# CHECK - One `PARTICIPANT_ID` per `CASE_ID` 
length(unique(initiations$CASE_PARTICIPANT_ID)) == length(initiations$CASE_PARTICIPANT_ID) # One `PARTICIPANT_ID` per `CASE_ID`

# remove duplicates
initiations <- initiations %>% distinct()

#-------#

## Intake ##
intake <- read_csv('./Intake.csv',col_types = cols(.default = "c"))

# CHECK - One `PARTICIPANT_ID` per `CASE_ID` 
length(unique(intake$CASE_PARTICIPANT_ID)) == length(intake$CASE_PARTICIPANT_ID)

# remove duplicates
intake <- intake %>% distinct()

```

### Visualize 1 ###
```{r}

# CHARGE_DISPOSITION ("In essence, we're asking the simple question, what happened to the top charge?")
table(dispositions$CHARGE_DISPOSITION)
windows()
p1 <- ggplot(dispositions, aes(x=CHARGE_DISPOSITION)) +
  geom_histogram(stat="count") +
  theme(axis.text.x = element_text(angle=90, hjust=1,size=7),axis.title.x = element_text(size = 9))
require(scales)
p1 + scale_y_continuous(labels = comma)

ggsave("ChargeDisposition.png",width = 8,height=5)

#-------#

# `RACE` column considering the following races.
race_considered = c("Black", "White", "HISPANIC")

# What were the final charges by the three races we're focusing on
windows()
p2 <- ggplot(dispositions[dispositions$RACE %in% race_considered,], aes(x=CLASS, fill=RACE,group=RACE)) +
  geom_histogram(stat='count') +
  facet_wrap(~RACE, nrow=3, scales = "free_y")

p2 + scale_y_continuous(labels = comma) +
  geom_text(aes(label =  scales::percent(..prop..),y = ..prop..), stat='count',colour="black",vjust=-0.5,fontface="bold")
  
ggsave("RaceChargeDisb.png",width = 8,height=5)

#-------#

# experimenting with visuals (WIP)
windows()
ggplot(class_change1[class_change1$RACE %in% race_considered,], aes(RACE, Freq, fill=CHARGE_REDUCTION)) + 
  geom_bar(stat='identity', position='dodge')

ggplot(class_change1[class_change1$RACE %in% race_considered,], aes(RACE, Freq, fill=CHARGE_REDUCTION)) +
  geom_bar(stat='identity', position='fill')

p3 <- ggplot(class_change1[class_change1$RACE %in% race_considered,], aes(CHARGE_REDUCTION, Freq, fill=CHARGE_REDUCTION,group=CHARGE_REDUCTION)) + 
  geom_bar(stat='identity') + 
  facet_wrap(~RACE, scales='free', nrow=1)
# p3 +
#   geom_text(aes(label = ..count..,y = ..count..), stat='count',colour="black",vjust=-0.5,fontface="bold")

# p4 <- ggplot(class_change1[class_change1$RACE %in% race_considered,], aes(CHARGE_REDUCTION,group=RACE)) + 
#   geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") + 
#   facet_wrap(~RACE, scales='free', nrow=1)
# p4 + scale_y_continuous(labels = comma) +
#   geom_text(aes(label =  scales::percent(..prop..),y = ..prop..), stat='count',colour="black",vjust=-0.5,fontface="bold")

```

### data manipulation 1 ###
```{r}

## Filter dispositions to Plea of Guilty
dispositions <- dispositions %>%
  filter(CHARGE_DISPOSITION  == 'Plea Of Guilty' | CHARGE_DISPOSITION  == 'Nolle Prosecution' | CHARGE_DISPOSITION  == 'Case Dismissed' | CHARGE_DISPOSITION  == 'SOL' | CHARGE_DISPOSITION  == 'SOLW')
  
initiations <- as.data.table(initiations)[, CHRG_INIT := length(PRIMARY_CHARGE), by = CASE_PARTICIPANT_ID][]

initiations$CLASS <- as.numeric(initiations$CLASS)
initiations <- as.data.table(initiations)[, MEAN_CLASS_INIT := mean(CLASS), by = CASE_PARTICIPANT_ID][]

d <- dispositions %>%
  group_by(CASE_PARTICIPANT_ID,PRIMARY_CHARGE) %>%
  filter(CHARGE_DISPOSITION == 'Plea Of Guilty') %>%
  summarise(CHRG_DISP = n())
dispositions <- dispositions %>%
  inner_join(d[,c('CASE_PARTICIPANT_ID','CHRG_DISP')],by = c("CASE_PARTICIPANT_ID"))

dispositions$CLASS <- as.numeric(dispositions$CLASS)
d <- dispositions %>%
  filter(CHARGE_DISPOSITION == 'Plea Of Guilty')
d <- d %>%
  group_by(CASE_PARTICIPANT_ID) %>%
  summarise(MEAN_CLASS_DISP = mean(CLASS,na.rm = TRUE))
dispositions <- dispositions %>%
  inner_join(d[,c('CASE_PARTICIPANT_ID','MEAN_CLASS_DISP')],by = c("CASE_PARTICIPANT_ID"))
  

#-------#

# Combine Initiations and Dispositions
disp_init <- initiations[,c('CASE_ID', 'CASE_PARTICIPANT_ID','CHARGE_ID','PRIMARY_CHARGE', 'CLASS','CHAPTER','ACT','SECTION','AOIC','AGE_AT_INCIDENT','GENDER','RACE','UPDATED_OFFENSE_CATEGORY', 'CHARGE_OFFENSE_TITLE','CHRG_INIT','MEAN_CLASS_INIT')] %>%
  rename(CLASS.INITIATIONS=CLASS) %>%
  inner_join(dispositions[,c('CASE_ID', 'CASE_PARTICIPANT_ID', 'CHARGE_ID', 'CLASS','JUDGE','COURT_NAME','COURT_FACILITY','DISPO_DATE', 'INCIDENT_BEGIN_DATE','ARREST_DATE','CHARGE_DISPOSITION','CHRG_DISP','MEAN_CLASS_DISP')], by = c("CASE_ID", "CASE_PARTICIPANT_ID", "CHARGE_ID")) %>%
  mutate(CHARGE_REDUCTION = ifelse(CLASS>CLASS.INITIATIONS, 1, 0))

# Modify CHARGE_DISPOSITION
disp_init <- disp_init %>% mutate(CHARGE_REDUCTION=as.factor(ifelse(CHARGE_DISPOSITION  == 'Nolle Prosecution' | CHARGE_DISPOSITION  == 'Case Dismissed' | CHARGE_DISPOSITION  == 'SOL' | CHARGE_DISPOSITION  == 'SOLW',1,CHARGE_REDUCTION)))

#-------#

# # Create table of Charge Reductions per Race
# class_change1 <- data.frame(table(disp_init$RACE, disp_init$CHARGE_REDUCTION)) %>%
#   rename(RACE=Var1, CHARGE_REDUCTION=Var2)
# 
# class_change2 <- subset(class_change1,class_change1$CHARGE_REDUCTION==1)
# 
# class_change3 <- class_change1 %>%
#   group_by(RACE) %>%
#   summarise(TOTAL=sum(Freq)) %>%
#   as.data.frame()
# 
# class_change3 <- cbind(class_change3,class_change2)
# class_change3$per <- class_change3$Freq/class_change3$TOTAL

# # Check what happens if we combine all hispanic & latino together
# class_change1$RACE <- as.character(class_change1$RACE)
# class_change1 <- class_change1 %>%
#   mutate(RACE=ifelse(RACE=="White/Black [Hispanic or Latino]"|RACE=="White [Hispanic or Latino]","HISPANIC",RACE)) %>%
#   group_by(RACE)
# class_change1$RACE <- as.factor(class_change1$RACE)
# class_change1 <- class_change1 %>%
#   group_by(RACE,CHARGE_REDUCTION) %>%
#   summarise(Freq=sum(Freq))

#-------#


```

### visualize 2 ###
```{r}

# visualise charge reductions by AGE
p <- ggplot(disp_init,aes(x=AGE_AT_INCIDENT,fill=CHARGE_REDUCTION)) + geom_bar(aes(y=..count..),position="dodge") + geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),stat="count", position=position_dodge(0.9), vjust=-0.5)
ggsave("AGECR.png",width = 70,height=10,limitsize = FALSE)

# visualise charge reductions by race
p <- ggplot(disp_init,aes(x=RACE,fill=CHARGE_REDUCTION)) + geom_bar(aes(y=..count..),position="dodge") + geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),stat="count", position=position_dodge(0.9), vjust=-0.5)
ggsave("RACECR.png",width = 15,height=5,limitsize = FALSE)

# visualise charge reductions by race
p <- ggplot(disp_init,aes(x=reorder(SECTION,SECTION,function(x)-length(x)),fill=CHARGE_REDUCTION)) + geom_bar(aes(y=..count..),position="dodge") + geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),stat="count", position=position_dodge(0.9), vjust=-0.5)
ggsave("SECTIONCR.png",width = 550,height=10,limitsize = FALSE)

# visualise charge reductions by GENDER
p <- ggplot(disp_init,aes(x=GENDER,fill=CHARGE_REDUCTION)) + geom_bar(aes(y=..count..),position="dodge") + geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),stat="count", position=position_dodge(0.9), vjust=-0.5)
ggsave("GENDERCR.png",width = 8,height=5,limitsize = FALSE)

# visualise charge reductions by OFFENSE CATEGORY
p <- ggplot(disp_init,aes(x=reorder(UPDATED_OFFENSE_CATEGORY,UPDATED_OFFENSE_CATEGORY,function(x)-length(x)),fill=CHARGE_REDUCTION)) + geom_bar(aes(y=..count..),position="dodge") + geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),stat="count", position=position_dodge(0.9), vjust=-0.5)
ggsave("UOCCR.png",width = 150,height=10,limitsize = FALSE)

# visualise charge reductions by JUDGE
p <- ggplot(disp_init,aes(x=reorder(JUDGE,JUDGE,function(x)-length(x)),fill=CHARGE_REDUCTION)) + geom_bar(aes(y=..count..),position="dodge") + geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),stat="count", position=position_dodge(0.9), vjust=-0.5)
ggsave("JUDGECR.png",width = 250,height=10,limitsize = FALSE)

# visualise charge reductions by COURT_FACILITY
p <- ggplot(disp_init,aes(x=reorder(COURT_FACILITY,COURT_FACILITY,function(x)-length(x)),fill=CHARGE_REDUCTION)) + geom_bar(aes(y=..count..),position="dodge") + geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),stat="count", position=position_dodge(0.9), vjust=-0.5)
ggsave("COURT_FACILITYCR.png",width = 20,height=5,limitsize = FALSE)

```

### data manipulation logit ###
```{r}

# Combine Initiations and Dispositions and intake
disp_init_intake <- intake[,c('CASE_ID', 'CASE_PARTICIPANT_ID','LAW_ENFORCEMENT_AGENCY','INCIDENT_CITY')] %>%
  inner_join(disp_init,by = c("CASE_ID", "CASE_PARTICIPANT_ID"))

disp_init_intake <- na.omit(disp_init_intake) #remove na's

#For Logistic regression - remove items not for prediction
disp_init_intake <- disp_init_intake[,-c(1,2,5,6,7,14,15,19,20,21)] 

## 80% rule for variables with lots of factors
x <- as.data.frame(table(disp_init_intake$LAW_ENFORCEMENT_AGENCY))
x <- x[order(-x$Freq),]
x$cs <- cumsum(x$Freq)
x$per <- x$cs/sum(x$Freq)
x <- x %>% filter(per>0.9)
disp_init_intake <- disp_init_intake %>% mutate(LAW_ENFORCEMENT_AGENCY=ifelse(LAW_ENFORCEMENT_AGENCY %in% x$Var1,"OTHER",LAW_ENFORCEMENT_AGENCY))

x <- as.data.frame(table(disp_init_intake$INCIDENT_CITY))
x <- x[order(-x$Freq),]
x$cs <- cumsum(x$Freq)
x$per <- x$cs/sum(x$Freq)
x <- x %>% filter(per>0.9)
disp_init_intake <- disp_init_intake %>% mutate(INCIDENT_CITY=ifelse(INCIDENT_CITY %in% x$Var1,"OTHER",INCIDENT_CITY))

x <- as.data.frame(table(disp_init_intake$SECTION))
x <- x[order(-x$Freq),]
x$cs <- cumsum(x$Freq)
x$per <- x$cs/sum(x$Freq)
x <- x %>% filter(per>0.95)
disp_init_intake <- disp_init_intake %>% mutate(SECTION=ifelse(SECTION %in% x$Var1,"OTHER",SECTION))

x <- as.data.frame(table(disp_init_intake$AOIC))
x <- x[order(-x$Freq),]
x$cs <- cumsum(x$Freq)
x$per <- x$cs/sum(x$Freq)
x <- x %>% filter(per>0.9)
disp_init_intake <- disp_init_intake %>% mutate(AOIC=ifelse(AOIC %in% x$Var1,"OTHER",AOIC))

x <- as.data.frame(table(disp_init_intake$INCIDENT_CITY))
x <- x[order(-x$Freq),]
x$cs <- cumsum(x$Freq)
x$per <- x$cs/sum(x$Freq)
x <- x %>% filter(per>0.9)
disp_init_intake <- disp_init_intake %>% mutate(INCIDENT_CITY=ifelse(INCIDENT_CITY %in% x$Var1,"OTHER",INCIDENT_CITY))

x <- as.data.frame(table(disp_init_intake$UPDATED_OFFENSE_CATEGORY))
x <- x[order(-x$Freq),]
x$cs <- cumsum(x$Freq)
x$per <- x$cs/sum(x$Freq)
x <- x %>% filter(per>0.9)
disp_init_intake <- disp_init_intake %>% mutate(UPDATED_OFFENSE_CATEGORY=ifelse(UPDATED_OFFENSE_CATEGORY %in% x$Var1,"OTHER",UPDATED_OFFENSE_CATEGORY))

x <- as.data.frame(table(disp_init_intake$JUDGE))
x <- x[order(-x$Freq),]
x$cs <- cumsum(x$Freq)
x$per <- x$cs/sum(x$Freq)
x <- x %>% filter(per>0.9)
disp_init_intake <- disp_init_intake %>% mutate(JUDGE=ifelse(JUDGE %in% x$Var1,"OTHER",JUDGE))

disp_init_intake <- as.data.frame(unclass(disp_init_intake)) #make all into factors
disp_init_intake$AGE_AT_INCIDENT <- as.numeric(disp_init_intake$AGE_AT_INCIDENT) #age should be numeric

dmy <- dummyVars(~ RACE, data = disp_init_intake)
df <- data.frame(predict(dmy, newdata = disp_init_intake))
DIILog <- cbind(disp_init_intake,df[,c("RACE.HISPANIC")])
DIILog <- DIILog %>% rename(RACE.HISPANIC=`df[, c("RACE.HISPANIC")]`)
DIILog$RACE <- NULL

dmy <- dummyVars(~ JUDGE, data = DIILog)
df <- data.frame(predict(dmy, newdata = DIILog))
DIILog <- cbind(DIILog,df[,c("JUDGE.Kerry.M.Kennedy","JUDGE.Mary.C.Roberts","JUDGE.Catherine.Marie.Haberkorn","JUDGE.Dennis.J.Porter","JUDGE.Geary.W.Kull","JUDGE.Gregory.Robert.Ginex","JUDGE.James.N.Karahalios","JUDGE.Jorge.Luis.Alonso","JUDGE.Marc.W.Martin","JUDGE.Maura..Slattery.Boyle","JUDGE.Michele.M.Pitman","JUDGE.Nicholas.R.Ford","JUDGE.Thaddeus.L.Wilson","JUDGE.Vincent.M.Gaughan","JUDGE.Carol.A.Kipperman","JUDGE.Frank.G.Zelezinski","JUDGE.James.B.Linn","JUDGE.Lawrence.Edward.Flood","JUDGE.Matthew.E.Coghlan","JUDGE.Rosemary.Grant.Higgins","JUDGE.Brian.K.Flaherty","JUDGE.Diane.Gordon.Cannon","JUDGE.Evelyn.B.Clay","JUDGE.Joan.Margaret.O.Brien","JUDGE.John.Joseph.Hynes","JUDGE.Kevin.M.Sheehan","JUDGE.Noreen.Valeria.Love","JUDGE.Sharon.M.Sullivan","JUDGE.William.H.Hooks")])
DIILog <- cbind(DIILog,df)
DIILog$JUDGE <- NULL

dmy <- dummyVars(~ LAW_ENFORCEMENT_AGENCY, data = DIILog)
df <- data.frame(predict(dmy, newdata = DIILog))
DIILog <- cbind(DIILog,df[,c("LAW_ENFORCEMENT_AGENCY.DOLTON.PD","LAW_ENFORCEMENT_AGENCY.FRANKLIN.PARK.PD","LAW_ENFORCEMENT_AGENCY.HARVEY.PD","LAW_ENFORCEMENT_AGENCY.ISP.DISTRICT.CHICAGO","LAW_ENFORCEMENT_AGENCY.OAK.PARK.PD","LAW_ENFORCEMENT_AGENCY.CHICAGO.PD","LAW_ENFORCEMENT_AGENCY.BELLWOOD.PD","LAW_ENFORCEMENT_AGENCY.COOK.COUNTY.SHERIFF..IL0160000.","LAW_ENFORCEMENT_AGENCY.DES.PLAINES.PD","LAW_ENFORCEMENT_AGENCY.EVANSTON.PD","LAW_ENFORCEMENT_AGENCY.MELROSE.PARK.PD","LAW_ENFORCEMENT_AGENCY.CALUMET.CITY.PD","LAW_ENFORCEMENT_AGENCY.CHICAGO.HEIGHTS.PD","LAW_ENFORCEMENT_AGENCY.CICERO.PD","LAW_ENFORCEMENT_AGENCY.OAK.LAWN.PD","LAW_ENFORCEMENT_AGENCY.OTHER")])
DIILog <- cbind(DIILog,df)
DIILog$LAW_ENFORCEMENT_AGENCY <- NULL

dmy <- dummyVars(~ INCIDENT_CITY, data = DIILog)
df <- data.frame(predict(dmy, newdata = DIILog))
DIILog <- cbind(DIILog,df[,c("INCIDENT_CITY.Evergreen.Park","INCIDENT_CITY.Oak.Park")])
DIILog <- cbind(DIILog,df)
DIILog$INCIDENT_CITY <- NULL

dmy <- dummyVars(~ SECTION, data = DIILog)
df <- data.frame(predict(dmy, newdata = DIILog))
DIILog <- cbind(DIILog,df[,c("INCIDENT_CITY.Evergreen.Park","INCIDENT_CITY.Oak.Park")])
DIILog <- cbind(DIILog,df)
DIILog$SECTION <- NULL

# split into training and test data
set.seed(123)
split = sample.split(DIILog$CHARGE_REDUCTION, SplitRatio = 0.7)
train = subset(DIILog, split == TRUE)
test = subset(DIILog, split == FALSE)


```

### Logistic Regression ###
```{r}
# Classification 1 (Logistic Regression)
CRLog <- glm(CHARGE_REDUCTION ~ SECTION,data = train,family = binomial)

CRLog_predict <- predict(CRLog,type = "response")
tapply(CRLog_predict,train$CHARGE_REDUCTION,mean)
table(train$CHARGE_REDUCTION,CRLog_predict>0.2)

CRLog_predict <- predict(CRLog,newdata = test,type = "response")




#TEST

CRLog_predict <- ifelse(CRLog_predict > 0.5,1,0)

confusionMatrix(data = as.numeric(CRLog_predict>0.5), reference = test$CHARGE_REDUCTION)

pr <- prediction(CRLog_predict,test$CHARGE_REDUCTION)
perf <- performance(pr,measure = "tpr",x.measure = "fpr")
plot(perf)
auc(new_test$Survived,log_predict)

```

### data manipulation xgb ###
```{r}
# Combine Initiations and Dispositions and intake
disp_init_intake <- intake[,c('CASE_ID', 'CASE_PARTICIPANT_ID','LAW_ENFORCEMENT_AGENCY','INCIDENT_CITY')] %>%
  inner_join(disp_init,by = c("CASE_ID", "CASE_PARTICIPANT_ID"))

disp_init_intake <- na.omit(disp_init_intake) #remove na's

#For Logistic regression - remove items not for prediction
disp_init_intake <- disp_init_intake[,-c(1,6,8,9,16,17,18,19,23,24,25,26,27,28)] 

# RACE only white and black
disp_init_intake <- disp_init_intake %>% filter(RACE == 'White' | RACE == 'Black')

disp_init_intake$AGE_AT_INCIDENT <- as.numeric(disp_init_intake$AGE_AT_INCIDENT) #age should be numeric

disp_init_intake[sapply(disp_init_intake, is.character)] <- lapply(disp_init_intake[sapply(disp_init_intake, is.character)],as.factor) #all into factors

disp_init_intake$CLASS.INITIATIONS <- as.factor(disp_init_intake$CLASS.INITIATIONS)
disp_init_intake$CHARGE_REDUCTION <- as.numeric(disp_init_intake$CHARGE_REDUCTION) #age should be numeric
disp_init_intake <- disp_init_intake %>% mutate(CHARGE_REDUCTION=ifelse(CHARGE_REDUCTION==1,0,1))

# # RACE only white and black 
# disp_init_intake <- disp_init_intake %>% filter(RACE == 'White' | RACE == 'Black')

disp_init_intake <- disp_init_intake %>% filter(UPDATED_OFFENSE_CATEGORY == 'Retail Theft')

# split into training and test data
set.seed(123)
split = sample.split(disp_init_intake$CHARGE_REDUCTION, SplitRatio = 0.5)
train = subset(disp_init_intake, split == TRUE)
test = subset(disp_init_intake, split == FALSE)

new_train <- model.matrix(~.+0,data = train[,-c(1,4,15)])
new_test <- model.matrix(~.+0,data = test[,-c(1,4,15)])

dTrain <- xgb.DMatrix(data = new_train,
                                  label = train$CHARGE_REDUCTION,
                                  missing = NaN)

dValidation <- xgb.DMatrix(data = new_test,
                                  label = test$CHARGE_REDUCTION,
                                  missing = NaN)

# fwrite(train,"train.csv")
# fwrite(test,"test.csv")

```

### xgboost ###
```{r}
start <- Sys.time()

params <- list(booster = "gbtree", objective = "binary:logistic", eta=0.1, gamma=5, max_depth=8, min_child_weight=1, subsample=1, colsample_bytree=1)

xgb_regression <- xgb.train (params = params, data = dTrain, nfold = 5,nrounds = 100, watchlist = list(val=dValidation,train=dTrain), print.every.n = 10, maximize = F , eval_metric = "auc")

end <- Sys.time()
end - start

mat <- xgb.importance (feature_names = colnames(new_train),model = xgb_regression)
windows()
xgb.plot.importance (importance_matrix = mat[1:20]) 

xgb_predict <- predict(xgb_regression,dValidation)
tapply(xgb_predict,test$CHARGE_REDUCTION,mean)
table(test$CHARGE_REDUCTION,xgb_predict>0.3)
table(test$RACE == 'Black',xgb_predict>0.3)
Predict <- cbind(test,xgb_predict)
Predict <- Predict %>% mutate(xgb_predict2=ifelse(xgb_predict>0.3,1,0))
# Predict <- Predict %>% filter(RACE == 'White')
# table(Predict$CHARGE_REDUCTION,Predict$xgb_predict>0.3)
# table(Predict$CHARGE_REDUCTION)

del2 <- Predict %>% group_by(RACE,xgb_predict2) %>% summarise(Count=n()) %>% mutate(freq = (Count/sum(Count))*100)

ROCRpred = prediction(xgb_predict, test$CHARGE_REDUCTION)
ROCRperf = performance(ROCRpred, "tpr", "fpr")
windows()
plot(ROCRperf, colorize=TRUE, print.cutoffs.at=seq(0,1,by=0.1), text.adj=c(-0.2,1.7))

```

## Convert to White 2nd Attempt
```{r}

disp_init_intake <- intake[,c('CASE_ID', 'CASE_PARTICIPANT_ID','LAW_ENFORCEMENT_AGENCY','INCIDENT_CITY')] %>%
  inner_join(disp_init,by = c("CASE_ID", "CASE_PARTICIPANT_ID"))

disp_init_intake <- na.omit(disp_init_intake) #remove na's

#For Logistic regression - remove items not for prediction
disp_init_intake <- disp_init_intake[,-c(1,6,8,9,16,17,18,19,23,24,25,26,27,28)] 

disp_init_intake$combined <- apply(disp_init_intake,1,function(x) paste(toString(x[2]),toString(x[3]),toString(x[7]),toString(x[11]),toString(x[12]),toString(x[13]),toString(x[14]),sep = "_"))

disp_init_intake_W1 <- disp_init_intake

# label RACE == 'Black'
disp_init_intake_W1 <- disp_init_intake_W1 %>% mutate(FLAG=ifelse(RACE=='Black',1,0))

disp_init_intake_W1 <- disp_init_intake_W1 %>% filter(RACE == 'White' | RACE == 'Black')

disp_init_intake_W1 <- disp_init_intake_W1 %>% filter(UPDATED_OFFENSE_CATEGORY == 'Retail Theft')

disp_init_intake_B <- disp_init_intake_W1 %>% filter(RACE=='Black')

#modify to white
WRatio <- disp_init_intake_W1 %>% filter(RACE=='White') %>% group_by(combined) %>% summarise(Count=n()) %>% mutate(freq = (Count/sum(Count))*100)
WRatio <- WRatio %>% mutate(freq2=cumsum(freq))
WRatio$freq2 <- (WRatio$freq2/100)

set.seed(123)
disp_init_intake_B$Rand <- runif(as.numeric(count(disp_init_intake_B)))
disp_init_intake_B <- disp_init_intake_B[order(disp_init_intake_B$Rand),]

i <- 1
repeat {
  if(i==1){
    disp_init_intake_B <- disp_init_intake_B %>% mutate(combined=ifelse(Rand<WRatio$freq2[i],WRatio$combined[i],combined))
  } else 
    {
    disp_init_intake_B <- disp_init_intake_B %>% mutate(combined=ifelse(Rand<WRatio$freq2[i],ifelse(Rand>=WRatio$freq2[i-1],WRatio$combined[i],combined),combined))
  }
  i = i + 1
  if(i>as.numeric(count(WRatio))){
    break
  }
}

j <- 1
repeat {
  disp_init_intake_B$LAW_ENFORCEMENT_AGENCY[j] <- strsplit(disp_init_intake_B$combined,"_")[[j]][1]
  disp_init_intake_B$INCIDENT_CITY[j] <- strsplit(disp_init_intake_B$combined,"_")[[j]][2]
  # disp_init_intake_B$CLASS.INITIATIONS[j] <- strsplit(disp_init_intake_B$combined,"_")[[j]][3]
  # disp_init_intake_B$SECTION[j] <- strsplit(disp_init_intake_B$combined,"_")[[j]][3]
  disp_init_intake_B$AOIC[j] <- strsplit(disp_init_intake_B$combined,"_")[[j]][3]
  disp_init_intake_B$UPDATED_OFFENSE_CATEGORY[j] <- strsplit(disp_init_intake_B$combined,"_")[[j]][4]
  disp_init_intake_B$JUDGE[j] <- strsplit(disp_init_intake_B$combined,"_")[[j]][5]
  disp_init_intake_B$COURT_NAME[j] <- strsplit(disp_init_intake_B$combined,"_")[[j]][6]
  disp_init_intake_B$COURT_FACILITY[j] <- strsplit(disp_init_intake_B$combined,"_")[[j]][7]
  
  j = j + 1
  
  if(j>as.numeric(count(disp_init_intake_B))){
    break
  }
}


# del <- disp_init_intake_B %>% group_by(INCIDENT_CITY) %>% summarise(Count=n()) %>% mutate(freq = (Count/sum(Count))*100)
# del2 <- disp_init_intake_W1 %>% filter(RACE=='White') %>% group_by(INCIDENT_CITY) %>% summarise(Count=n()) %>% mutate(freq = (Count/sum(Count))*100)

disp_init_intake_B <- disp_init_intake_B %>% mutate(RACE='White')
disp_init_intake_B$Rand <- NULL

disp_init_intake_W1 <- disp_init_intake_W1 %>% filter(RACE=='White')

disp_init_intake_W1 <- rbind(disp_init_intake_W1,disp_init_intake_B)

disp_init_intake_W1$AGE_AT_INCIDENT <- as.numeric(disp_init_intake_W1$AGE_AT_INCIDENT) #age should be numeric

disp_init_intake_W1[sapply(disp_init_intake_W1, is.character)] <- lapply(disp_init_intake_W1[sapply(disp_init_intake_W1, is.character)],as.factor) #all into factors

Map1 <- mapLevels(x=list(disp_init_intake_W1$COURT_FACILITY, disp_init_intake$COURT_FACILITY),codes=FALSE,combine=TRUE)
Map2 <- mapLevels(x=list(disp_init_intake_W1$INCIDENT_CITY, disp_init_intake$INCIDENT_CITY),codes=FALSE,combine=TRUE)
Map3 <- mapLevels(x=list(disp_init_intake_W1$COURT_NAME, disp_init_intake$COURT_NAME),codes=FALSE,combine=TRUE)
Map4 <- mapLevels(x=list(disp_init_intake_W1$RACE, disp_init_intake$RACE),codes=FALSE,combine=TRUE)
Map5 <- mapLevels(x=list(disp_init_intake_W1$LAW_ENFORCEMENT_AGENCY, disp_init_intake$LAW_ENFORCEMENT_AGENCY),codes=FALSE,combine=TRUE)
Map6 <- mapLevels(x=list(disp_init_intake_W1$CLASS.INITIATIONS, disp_init_intake$CLASS.INITIATIONS),codes=FALSE,combine=TRUE)
Map7 <- mapLevels(x=list(disp_init_intake_W1$SECTION, disp_init_intake$SECTION),codes=FALSE,combine=TRUE)
Map8 <- mapLevels(x=list(disp_init_intake_W1$AOIC, disp_init_intake$AOIC),codes=FALSE,combine=TRUE)
Map9 <- mapLevels(x=list(disp_init_intake_W1$GENDER, disp_init_intake$GENDER),codes=FALSE,combine=TRUE)
Map10 <- mapLevels(x=list(disp_init_intake_W1$UPDATED_OFFENSE_CATEGORY, disp_init_intake$UPDATED_OFFENSE_CATEGORY),codes=FALSE,combine=TRUE)
Map11 <- mapLevels(x=list(disp_init_intake_W1$JUDGE, disp_init_intake$JUDGE),codes=FALSE,combine=TRUE)

mapLevels(disp_init_intake_W1$COURT_FACILITY) <- Map1
mapLevels(disp_init_intake_W1$INCIDENT_CITY) <- Map2
mapLevels(disp_init_intake_W1$COURT_NAME) <- Map3
mapLevels(disp_init_intake_W1$RACE) <- Map4
mapLevels(disp_init_intake_W1$LAW_ENFORCEMENT_AGENCY) <- Map5
mapLevels(disp_init_intake_W1$CLASS.INITIATIONS) <- Map6
mapLevels(disp_init_intake_W1$SECTION) <- Map7
mapLevels(disp_init_intake_W1$AOIC) <- Map8
mapLevels(disp_init_intake_W1$GENDER) <- Map9
mapLevels(disp_init_intake_W1$UPDATED_OFFENSE_CATEGORY) <- Map10
mapLevels(disp_init_intake_W1$JUDGE) <- Map11

disp_init_intake_W1$CLASS.INITIATIONS <- as.factor(disp_init_intake_W1$CLASS.INITIATIONS)

disp_init_intake_W1$CHARGE_REDUCTION <- as.numeric(disp_init_intake_W1$CHARGE_REDUCTION) #age should be numeric
disp_init_intake_W1 <- disp_init_intake_W1 %>% mutate(CHARGE_REDUCTION=ifelse(CHARGE_REDUCTION==1,0,1))

# test <- disp_init_intake_W1

set.seed(123)
split = sample.split(disp_init_intake_W1$CHARGE_REDUCTION, SplitRatio = 0.5)
train = subset(disp_init_intake_W1, split == TRUE)
test = subset(disp_init_intake_W1, split == FALSE)

new_train <- model.matrix(~.+0,data = train[,-c(1,4,15,16,17)])
new_test <- model.matrix(~.+0,data = test[,-c(1,4,15,16,17)])

dTrain <- xgb.DMatrix(data = new_train,
                                  label = train$CHARGE_REDUCTION,
                                  missing = NaN)

dValidation <- xgb.DMatrix(data = new_test,
                                  label = test$CHARGE_REDUCTION,
                                  missing = NaN)

xgb_predict_W1 <- predict(xgb_regression,dValidation)
table(test$FLAG==1,xgb_predict_W1>0.3)
table(test$CHARGE_REDUCTION,xgb_predict_W1>0.3)
W1_Predict <- cbind(test,xgb_predict_W1)
W1_Predict <- W1_Predict %>% mutate(xgb_predict_W1_2=ifelse(xgb_predict_W1>0.3,1,0))
del <- W1_Predict %>% group_by(FLAG,xgb_predict_W1_2) %>% summarise(Count=n()) %>% mutate(freq = (Count/sum(Count))*100)

# # experiment
# W1_Predict <- W1_Predict %>% mutate(FLAG2 = ifelse(xgb_predict_W1>0.3,1,0))
# W1_Predict2 <- W1_Predict %>% filter(FLAG==1)
# Predict <- Predict %>% mutate(FLAG2 = ifelse(xgb_predict>0.3,1,0))
# Predict2 <- Predict %>% filter(RACE=='Black')
#

Predict$CASE_PARTICIPANT_ID <- as.character(Predict$CASE_PARTICIPANT_ID)
Predict$CHARGE_ID <- as.character(Predict$CHARGE_ID)
W1_Predict$CASE_PARTICIPANT_ID <- as.character(W1_Predict$CASE_PARTICIPANT_ID)
W1_Predict$CHARGE_ID <- as.character(W1_Predict$CHARGE_ID)
Predict_Comb <- Predict %>%
  inner_join(W1_Predict,by = c("CASE_PARTICIPANT_ID","CHARGE_ID"))
tapply(Predict_Comb$xgb_predict_W1,Predict_Comb$RACE.x,mean)
tapply(Predict_Comb$xgb_predict,Predict_Comb$RACE.x,mean)
Predict_Comb2 <- Predict_Comb %>% filter(xgb_predict2 == 0 & xgb_predict_W1_2 == 1)
Predict_Comb2 <- Predict_Comb2 %>% filter(INCIDENT_CITY.x == INCIDENT_CITY.y)
Predict_Comb2 <- Predict_Comb2 %>% mutate(check = xgb_predict_W1 - xgb_predict)

Predict2 <- Predict %>% filter(INCIDENT_CITY=='Skokie' & RACE == 'White')

# 
# Check <- Predict_Comb %>% filter(FLAG2.y>FLAG2.x)
# fwrite(Check,"Case.csv")
# 
# Check2 <- Predict_Comb %>% filter(xgb_predict_W1>xgb_predict)
# fwrite(Check2,"Case2.csv")

```

## Convert to White
```{r}

disp_init_intake <- intake[,c('CASE_ID', 'CASE_PARTICIPANT_ID','LAW_ENFORCEMENT_AGENCY','INCIDENT_CITY')] %>%
  inner_join(disp_init,by = c("CASE_ID", "CASE_PARTICIPANT_ID"))

disp_init_intake <- na.omit(disp_init_intake) #remove na's

#For Logistic regression - remove items not for prediction
disp_init_intake <- disp_init_intake[,-c(1,6,7,14,15,19,20,21,22)] 

## combine levels
# disp_init_intake$combined <- apply(disp_init_intake,1,function(x) paste(toString(x[2]),toString(x[8]),toString(x[11]),toString(x[12])))
# disp_init_intake$combined <- apply(disp_init_intake,1,function(x) paste(toString(x[1]),toString(x[2]),toString(x[5]),toString(x[8]),toString(x[9]),toString(x[10]),toString(x[11]),toString(x[12])))

## Look at count of vars
# del <- disp_init_intake %>% filter(RACE=='White',CHARGE_REDUCTION==1,CLASS.INITIATIONS==3) %>% group_by(RACE,INCIDENT_CITY) %>% summarise(Count=n())
# del2 <- disp_init_intake %>% filter(RACE=='Black',CHARGE_REDUCTION==1,CLASS.INITIATIONS==3) %>% group_by(RACE,INCIDENT_CITY) %>% summarise(Count=n())
# del <- disp_init_intake %>% filter(INCIDENT_CITY=='Niles') %>% group_by(RACE,CHARGE_REDUCTION) %>% summarise(Count=n()) %>% mutate(freq = (Count/sum(Count))*100)
# del <- disp_init_intake %>% filter(RACE=='White',CHARGE_REDUCTION==1) %>% group_by(INCIDENT_CITY) %>% summarise(Count=n()) %>% mutate(freq = (Count/sum(Count))*100)
# del <- disp_init_intake %>% filter() %>% group_by(INCIDENT_CITY,CHARGE_REDUCTION) %>% summarise(Count=n()) %>% mutate(freq = (Count/sum(Count))*100)
# del2 <- disp_init_intake %>% filter(RACE=='Black') %>% group_by(INCIDENT_CITY,CHARGE_REDUCTION) %>% summarise(Count=n()) %>% mutate(freq = (Count/sum(Count))*100)
# 
# del3 <- del %>% inner_join(del2,by=c("INCIDENT_CITY","CHARGE_REDUCTION")) %>% mutate(FLAG = ifelse(CHARGE_REDUCTION==1,ifelse(freq.x>freq.y,1,0),0)) %>% filter(FLAG==1)

del <- disp_init_intake %>% filter(RACE=='White') %>% group_by(INCIDENT_CITY) %>% summarise(Count=n()) %>% mutate(freq = (Count/sum(Count))*100)

disp_init_intake_W1 <- disp_init_intake

# label RACE == 'Black'
disp_init_intake_W1 <- disp_init_intake_W1 %>% mutate(FLAG=ifelse(RACE=='Black',1,0))

# disp_init_intake_W2 <- disp_init_intake %>% mutate(LAW_ENFORCEMENT_AGENCY=ifelse(RACE=='Black','CHICAGO PD',LAW_ENFORCEMENT_AGENCY),
#                                                   INCIDENT_CITY=ifelse(RACE=='Black','Chicago',INCIDENT_CITY),
#                                                   SECTION=ifelse(RACE=='Black','402(c)',SECTION),
#                                                   AOIC=ifelse(RACE=='Black','5101110',AOIC),
#                                                   UPDATED_OFFENSE_CATEGORY=ifelse(RACE=='Black','Narcotics',UPDATED_OFFENSE_CATEGORY),
#                                                   JUDGE=ifelse(RACE=='Black','Colleen Ann Hyland',JUDGE),
#                                                   COURT_NAME=ifelse(RACE=='Black','District 1 - Chicago',COURT_NAME),
#                                                   COURT_FACILITY=ifelse(RACE=='Black','26TH Street',COURT_FACILITY),
#                                                   RACE=ifelse(RACE=='Black','White',RACE))

# RACE only white and black
disp_init_intake_W1 <- disp_init_intake_W1 %>% filter(RACE == 'White' | RACE == 'Black')

disp_init_intake_W1[sapply(disp_init_intake_W1, is.character)] <- lapply(disp_init_intake_W1[sapply(disp_init_intake_W1, is.character)],as.factor) #all into factors

# disp_init_intake_W1$AGE_AT_INCIDENT <- as.numeric(disp_init_intake_W1$AGE_AT_INCIDENT) #age should be numeric
# disp_init_intake_W1$CHARGE_REDUCTION <- as.numeric(disp_init_intake_W1$CHARGE_REDUCTION) #age should be numeric
# disp_init_intake_W1 <- disp_init_intake_W1 %>% mutate(CHARGE_REDUCTION=ifelse(CHARGE_REDUCTION==1,0,1))

# disp_init_intake_W1 <- disp_init_intake_W1 %>% mutate(INCIDENT_CITY=as.factor(ifelse(RACE=='Black',"Schaumburg",as.character(INCIDENT_CITY))),
#                                                   COURT_NAME=as.factor(ifelse(RACE=='Black',"District 3 - Rolling Meadows",as.character(COURT_NAME))),
#                                                   COURT_FACILITY=as.factor(ifelse(RACE=='Black',"Rolling Meadows Courthouse",as.character(COURT_FACILITY))),
#                                                   RACE=as.factor(ifelse(RACE=='Black',"White",as.character(RACE))))

# Map1 <- mapLevels(x=list(disp_init_intake_W1$COURT_FACILITY, disp_init_intake$COURT_FACILITY),codes=FALSE,combine=TRUE)
# Map2 <- mapLevels(x=list(disp_init_intake_W1$INCIDENT_CITY, disp_init_intake$INCIDENT_CITY),codes=FALSE,combine=TRUE)
# Map3 <- mapLevels(x=list(disp_init_intake_W1$COURT_NAME, disp_init_intake$COURT_NAME),codes=FALSE,combine=TRUE)
# Map4 <- mapLevels(x=list(disp_init_intake_W1$RACE, disp_init_intake$RACE),codes=FALSE,combine=TRUE)
# 
# mapLevels(disp_init_intake_W1$COURT_FACILITY) <- Map1
# mapLevels(disp_init_intake_W1$INCIDENT_CITY) <- Map2
# mapLevels(disp_init_intake_W1$COURT_NAME) <- Map3
# mapLevels(disp_init_intake_W1$RACE) <- Map4

disp_init_intake_W1 <- disp_init_intake_W1 %>% filter(UPDATED_OFFENSE_CATEGORY == 'Theft')

# # RACE only white and black
# disp_init_intake_W1 <- disp_init_intake_W1 %>% filter(RACE == 'White' | RACE == 'Black')

disp_init_intake_W2 <- SMOTE(RACE ~ ., as.data.frame(disp_init_intake_W1),perc.over = 1000,perc.under = 0)
set.seed(111)
disp_init_intake_W2$Rand <- runif(12991)
disp_init_intake_W2 <- disp_init_intake_W2[order(disp_init_intake_W2$Rand),]
disp_init_intake_W2 <- disp_init_intake_W2[c(1:2832),]
# disp_init_intake_W2 <- disp_init_intake_W2[,-c(4,10)]
# dii_tobind <- disp_init_intake_W1 %>% filter(RACE=='Black')
# dii_tobind <- dii_tobind[,c(4,10)]
# disp_init_intake_W2 <- cbind(disp_init_intake_W2,dii_tobind)
# disp_init_intake_W2 <- disp_init_intake_W2[c(1,2,3,15,4,5,6,7,8,16,9,10,11,12,13)]

disp_init_intake_W1 <- disp_init_intake_W2
disp_init_intake_W1 <- disp_init_intake_W2[,-c(16)]

disp_init_intake_W1$AGE_AT_INCIDENT <- as.numeric(disp_init_intake_W1$AGE_AT_INCIDENT) #age should be numeric
disp_init_intake_W1$CHARGE_REDUCTION <- as.numeric(disp_init_intake_W1$CHARGE_REDUCTION) #age should be numeric
disp_init_intake_W1 <- disp_init_intake_W1 %>% mutate(CHARGE_REDUCTION=ifelse(CHARGE_REDUCTION==1,0,1))

test <- disp_init_intake_W1

set.seed(123)
split = sample.split(disp_init_intake_W1$CHARGE_REDUCTION, SplitRatio = 0.7)
train = subset(disp_init_intake_W1, split == TRUE)
test = subset(disp_init_intake_W1, split == FALSE)

new_train <- model.matrix(~.+0,data = train[,-c(1,14,15)])
new_test <- model.matrix(~.+0,data = test[,-c(1,14,15)])

dTrain <- xgb.DMatrix(data = new_train,
                                  label = train$CHARGE_REDUCTION,
                                  missing = NaN)

dValidation <- xgb.DMatrix(data = new_test,
                                  label = test$CHARGE_REDUCTION,
                                  missing = NaN)

xgb_predict_W1 <- predict(xgb_regression,dValidation)
table(test$FLAG==1,xgb_predict_W1>0.3)
table(xgb_predict_W1>0.3)
W1_Predict <- cbind(test,xgb_predict_W1)

# # experiment
# W1_Predict <- W1_Predict %>% mutate(FLAG2 = ifelse(xgb_predict_W1>0.3,1,0))
# W1_Predict2 <- W1_Predict %>% filter(FLAG==1)
# Predict <- Predict %>% mutate(FLAG2 = ifelse(xgb_predict>0.3,1,0))
# Predict2 <- Predict %>% filter(RACE=='Black')
# 
# Predict_Comb <- Predict2[,c('CASE_PARTICIPANT_ID', 'xgb_predict')] %>%
#   inner_join(W1_Predict2,by = c("CASE_PARTICIPANT_ID"))
# 
# Check <- Predict_Comb %>% filter(FLAG2.y>FLAG2.x)
# fwrite(Check,"Case.csv")
# 
# Check2 <- Predict_Comb %>% filter(xgb_predict_W1>xgb_predict)
# fwrite(Check2,"Case2.csv")

```

```{r}

W <- disp_init_intake %>% group_by(RACE,LAW_ENFORCEMENT_AGENCY) %>% summarise(Count = n())
W <- W %>% mutate(Max=max(Count))
W$LAW_ENFORCEMENT_AGENCY <- as.character(W$LAW_ENFORCEMENT_AGENCY)
W <- W %>% mutate(LAW_ENFORCEMENT_AGENCY=ifelse((Count/Max)<0.05,"Other",LAW_ENFORCEMENT_AGENCY))
W$LAW_ENFORCEMENT_AGENCY <- as.factor(W$LAW_ENFORCEMENT_AGENCY)
W <- W %>% filter(RACE=="HISPANIC") %>% group_by(LAW_ENFORCEMENT_AGENCY) %>% summarise(Count=sum(Count))
W$Label <- paste(W$LAW_ENFORCEMENT_AGENCY, paste(round(((W$Count/sum(W$Count))*100),2),"%"),W$Count, sep=" - ")
W <- W %>% 
  mutate(end = 2 * pi * cumsum(Count)/sum(Count),
         start = lag(end, default = 0),
         middle = 0.5 * (start + end),
         hjust = ifelse(middle > pi, 1, 0),
         vjust = ifelse(middle < pi/2 | middle > 3 * pi/2, 0, 1))

p <- ggplot(W) + 
  geom_arc_bar(aes(x0 = 0, y0 = 0, r0 = 0, r = 1,
                   start = start, end = end, fill = LAW_ENFORCEMENT_AGENCY)) +
  geom_text(aes(x = 1.1 * sin(middle), y = 1.05 * cos(middle), label = Label,
                hjust = hjust, vjust = vjust)) +
  coord_fixed() +
  scale_x_continuous(limits = c(-2.5, 2.5),  # Adjust so labels are not cut off
                     name = "", breaks = NULL, labels = NULL) +
  scale_y_continuous(limits = c(-1.5, 1.5),      # Adjust so labels are not cut off
                     name = "", breaks = NULL, labels = NULL)
ggsave("Pie.png",width = 30,height=8,limitsize = FALSE)


W <- disp_init_intake %>% group_by(RACE,CLASS,LAW_ENFORCEMENT_AGENCY) %>% summarise(Count = n())
W <- W %>% mutate(Max=max(Count))
W$CLASS <- as.character(W$CLASS)
W <- W %>% mutate(CLASS=ifelse((Count/Max)<0.05,"Other",CLASS))
W$CLASS <- as.factor(W$CLASS)
W <- W %>% filter(RACE=="HISPANIC" & LAW_ENFORCEMENT_AGENCY== "CHICAGO PD" | LAW_ENFORCEMENT_AGENCY == "CICERO PD") %>% group_by(CLASS) %>% summarise(Count=sum(Count))
W$Label <- paste(W$CLASS, paste(round(((W$Count/sum(W$Count))*100),2),"%"),W$Count, sep=" - ")
W <- W %>% 
  mutate(end = 2 * pi * cumsum(Count)/sum(Count),
         start = lag(end, default = 0),
         middle = 0.5 * (start + end),
         hjust = ifelse(middle > pi, 1, 0),
         vjust = ifelse(middle < pi/2 | middle > 3 * pi/2, 0, 1))

p <- ggplot(W) + 
  geom_arc_bar(aes(x0 = 0, y0 = 0, r0 = 0, r = 1,
                   start = start, end = end, fill = CLASS)) +
  geom_text(aes(x = 1.1 * sin(middle), y = 1.05 * cos(middle), label = Label,
                hjust = hjust, vjust = vjust)) +
  coord_fixed() +
  scale_x_continuous(limits = c(-2.5, 2.5),  # Adjust so labels are not cut off
                     name = "", breaks = NULL, labels = NULL) +
  scale_y_continuous(limits = c(-1.5, 1.5),      # Adjust so labels are not cut off
                     name = "", breaks = NULL, labels = NULL)
ggsave("PieH2.png",width = 20,height=6,limitsize = FALSE)

#-------#

#charge distribution by race
disp_init_intake <- disp_init_intake %>% filter(RACE == 'White' | RACE == 'Black')

del <- disp_init_intake %>%
  group_by(RACE,CLASS.INITIATIONS) %>%
  summarise(Count=n()) %>%
  mutate(freq = (Count/sum(Count))*100)

del2 <- disp_init_intake %>%
  group_by(RACE,CLASS) %>%
  summarise(Count=n()) %>%
  mutate(freq = (Count/sum(Count))*100)

del <- disp_init_intake %>%
  group_by(RACE) %>%
  summarise(mean(CHRG_INIT),
            mean(MEAN_CLASS_INIT),
            mean(CHRG_DISP),
            mean(MEAN_CLASS_DISP))

del <- initiations %>%
  filter(RACE == 'White' | RACE == 'Black') %>%
  group_by(RACE) %>%
  summarise(mean(CHRG_INIT),
            mean(MEAN_CLASS_INIT))

del <- dispositions %>%
  filter(RACE == 'White' | RACE == 'Black') %>%
  group_by(RACE) %>%
  summarise(mean(CHRG_DISP),
            mean(MEAN_CLASS_DISP))
  

```


### Questions ###
1. Are there newer versions of the data files available?
2. What is primary charge == FALSE ? Including all these non-unique cases? My assumption is secondary charges.
3. What are some of the other Charge_disposition types?
4. Charge count removed because only value is 1? How do we think about multiple charges?
5. Is every section unique to an ACT and CHAPTER? I think I've found, yes.
6. What is the threshold we want to impose? In other words, do we want to inaccurately reduce charge more often or inaccurately not reduce charge more often?

### Notes ###
1. When converting RACE to WHITE, some variables we want to change and others retain. 
  a) INCIDENT_CITY - Retain
  b) SECTION - Retain
  c) AOIC - Retain
  d) AGE_AT_INCIDENT - Sample
  e) GENDER - Sample
  f) RACE - base
  g) UPDATED_OFFENSE_CATEGORY - retain
  h) JUDGE - retain
  i) COURT_NAME - retain
  j) COURT_FACILITY - retain
  
  look at charge after vs before reduction